<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG åŠ‡æƒ…è¦–è¦ºåŒ–ç·¨è¼¯å™¨ (é€²éšç‰ˆ)</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --accent: #d4af37;
            --text: #ddd;
            --border: #3e3e42;
            --input-bg: #3c3c3c;
            --danger: #e74c3c;
            --success: #2ecc71;
            --info: #3498db;
        }
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        /* å·¦å´å°èˆª */
        .sidebar {
            width: 280px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 15px;
            background: #333;
            font-weight: bold;
            color: var(--accent);
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        .nav-tabs {
            display: flex;
            background: #2d2d2d;
        }
        .nav-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 0.9rem;
        }
        .nav-tab.active {
            border-bottom-color: var(--accent);
            color: #fff;
            background: #3e3e42;
        }
        .list-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .list-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-item:hover { background: #333; }
        .list-item.active { background: #37373d; border-left: 3px solid var(--accent); }
        .list-item .tag { font-size: 0.75rem; background: #555; padding: 2px 6px; border-radius: 4px; }

        /* å³å´ç·¨è¼¯å€ */
        .main-editor {
            flex-grow: 1;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .editor-toolbar {
            padding: 10px 20px;
            background: #333;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editor-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* è¡¨å–®å…ƒä»¶ */
        h3 { color: var(--accent); border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 25px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #aaa; }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            background: var(--input-bg);
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }
        textarea { resize: vertical; min-height: 60px; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        
        /* ç‰¹æ®Šæ¨£å¼ï¼šç¦æ­¢ç·¨è¼¯ */
        input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            border-color: #555;
            background: #2a2a2a;
            color: #888;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        button.primary { background: var(--accent); color: #000; }
        button.primary:hover { background: #f1c40f; }
        button.danger { background: var(--danger); color: #fff; }
        button.success { background: var(--success); color: #fff; }
        button.outline { background: transparent; border: 1px solid #666; color: #ccc; }
        button.outline:hover { border-color: #aaa; color: #fff; }
        button.sm { padding: 4px 8px; font-size: 0.8rem; }

        /* å¡ç‰‡å®¹å™¨ */
        .card-box {
            background: #2d2d30;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #444;
            border-radius: 6px;
            position: relative;
        }
        .card-header-actions {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        /* éš±è— */
        .hidden { display: none !important; }
        
        /* æ•¸å€¼ç·¨è¼¯ç¶²æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .stat-input-group {
            display: flex;
            align-items: center;
            background: #222;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #444;
        }
        .stat-input-group label { margin: 0; flex-grow: 1; color: #ddd; }
        .stat-input-group input { width: 80px; text-align: right; }

        /* === Toggle Switch é–‹é—œæ¨£å¼ === */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
            margin-right: 10px;
        }

        .toggle-switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #555; /* é è¨­ï¼šç´¯åŠ æ¨¡å¼ (ç°è‰²) */
            transition: .3s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: #e74c3c; }
        input:checked + .slider:before { transform: translateX(24px); }
        .mode-label-box.danger-mode { border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
        
        /* Checkbox Toggle ç°¡åŒ–ç‰ˆæ¨£å¼ */
        .t-switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-right: 10px; }
        .t-switch input { opacity: 0; width: 0; height: 0; }
        .t-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .t-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .t-slider { background-color: #e74c3c; }
        input:checked + .t-slider:before { transform: translateX(20px); }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            RPG Story Editor
            <div style="font-size: 0.8rem; color: #888; font-weight: normal;">æ•™å­¸å°ˆç”¨ç‰ˆ v2.2 (Items+)</div>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('scenes')">å ´æ™¯ (Scenes)</div>
            <div class="nav-tab" onclick="switchTab('endings')">çµå±€ (Endings)</div>
            <div class="nav-tab" onclick="switchTab('config')">è¨­å®š (Config)</div>
        </div>

        <div id="list-scenes" class="list-container">
            <div style="padding:10px;"><button class="outline" style="width:100%" onclick="addNewScene()">+ æ–°å¢å ´æ™¯</button></div>
            <div id="scene-list-ul"></div>
        </div>
        
        <div id="list-endings" class="list-container hidden">
            <div style="padding:10px;"><button class="outline" style="width:100%" onclick="addNewEnding()">+ æ–°å¢çµå±€</button></div>
            <div id="ending-list-ul"></div>
        </div>

        <div id="list-config" class="list-container hidden">
            <div style="padding: 20px; text-align: center; color: #888;">
                è«‹ç›´æ¥åœ¨å³å´ç·¨è¼¯å…¨åŸŸè¨­å®š
            </div>
        </div>

        <div style="padding: 10px; border-top: 1px solid #444; background: #222;">
            <button class="primary" style="width: 100%; margin-bottom: 5px;" onclick="exportJSON()">ğŸ’¾ ä¸‹è¼‰ story.json</button>
            <input type="file" id="import-file" style="display: none" onchange="importJSON(this)">
            <button class="outline" style="width: 100%" onclick="document.getElementById('import-file').click()">ğŸ“‚ åŒ¯å…¥èˆŠæª”</button>
        </div>
    </div>

    <div class="main-editor">
        <div class="editor-toolbar">
            <span id="editor-title" style="font-size: 1.2rem; font-weight: bold; color: var(--accent);">æº–å‚™å°±ç·’</span>
            <button id="btn-delete" class="danger hidden" onclick="deleteCurrentItem()">åˆªé™¤æ­¤é …ç›®</button>
        </div>

        <div id="editor-content-area" class="editor-content">
            <div style="text-align: center; margin-top: 100px; color: #666;">
                è«‹å¾å·¦å´é¸æ“‡é …ç›®é–‹å§‹ç·¨è¼¯ï¼Œæˆ–é»æ“Šã€ŒåŒ¯å…¥èˆŠæª”ã€è¼‰å…¥ story.json
            </div>
        </div>
    </div>

    <script>
        // === è³‡æ–™çµæ§‹ ===
        let storyData = {
            config: {
                title: "æœªå‘½åæ•…äº‹",
                stats: [
                    { id: "hp", name: "ç”Ÿå‘½å€¼", init: 100, color: "#e74c3c" }
                ],
                items: [] // æ–°å¢ï¼šé“å…·æ¸…å–®
            },
            scenes: {
                "intro": {
                    bg: "", bgm: "", dialogues: ["æ­¡è¿ä¾†åˆ°é€™å€‹æ•…äº‹ã€‚"], choices: []
                }
            },
            endings: []
        };

        let currentTab = 'scenes';
        let currentId = 'intro';

        function init() { renderList(); }

        // === ä»‹é¢åˆ‡æ›é‚è¼¯ ===
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('list-scenes').classList.add('hidden');
            document.getElementById('list-endings').classList.add('hidden');
            document.getElementById('list-config').classList.add('hidden');
            
            document.getElementById(`list-${tab}`).classList.remove('hidden');

            if (tab === 'config') renderConfigEditor();
            else renderList();
        }

        // === æ¸²æŸ“åˆ—è¡¨ ===
        function renderList() {
            const container = currentTab === 'scenes' ? document.getElementById('scene-list-ul') : document.getElementById('ending-list-ul');
            container.innerHTML = '';

            if (currentTab === 'scenes') {
                Object.keys(storyData.scenes).forEach(key => {
                    const div = document.createElement('div');
                    div.className = `list-item ${currentId === key ? 'active' : ''}`;
                    div.innerText = key;
                    div.onclick = () => { currentId = key; renderList(); renderSceneEditor(key); };
                    container.appendChild(div);
                });
            } else if (currentTab === 'endings') {
                storyData.endings.forEach((ending, index) => {
                    const div = document.createElement('div');
                    div.className = `list-item ${currentId === index ? 'active' : ''}`;
                    div.innerHTML = `<span>${ending.title || 'æœªå‘½åçµå±€'}</span> <span class="tag">P:${ending.priority||0}</span>`;
                    div.onclick = () => { currentId = index; renderList(); renderEndingEditor(index); };
                    container.appendChild(div);
                });
            }
        }

        // ==========================================================
        //  ç·¨è¼¯å™¨æ¸²æŸ“ (æ ¸å¿ƒé‚è¼¯)
        // ==========================================================

        // 1. è¨­å®š (Config) - åŒ…å« Stats å’Œ Items
        function renderConfigEditor() {
            const container = document.getElementById('editor-content-area');
            document.getElementById('editor-title').innerText = "å…¨åŸŸè¨­å®š (Config)";
            document.getElementById('btn-delete').classList.add('hidden');

            container.innerHTML = `
                <div class="form-group">
                    <label>æ•…äº‹æ¨™é¡Œ (Title)</label>
                    <input type="text" value="${storyData.config.title || ''}" oninput="storyData.config.title = this.value">
                </div>
                
                <h3>ç©å®¶æ•¸å€¼å®šç¾© (Stats)</h3>
                <p style="font-size:0.8rem; color:#888;">å®šç¾©éŠæˆ²ä¸­æœƒç”¨åˆ°çš„è®Šæ•¸ï¼ŒID åªèƒ½ç‚ºè‹±æ–‡èˆ‡æ•¸å­—ã€‚</p>
                <div id="stats-config-list"></div>
                <button class="outline sm" onclick="addStatConfig()">+ æ–°å¢æ•¸å€¼</button>

                <h3>é“å…·åœ–é‘‘ (Items)</h3>
                <p style="font-size:0.8rem; color:#888;">å®šç¾©éŠæˆ²ä¸­å¯ç²å¾—çš„é“å…·ã€‚</p>
                <div id="items-config-list"></div>
                <button class="outline sm" onclick="addItemConfig()">+ æ–°å¢é“å…·</button>
            `;
            renderStatConfigList();
            renderItemConfigList();
        }

        function renderStatConfigList() {
            const list = document.getElementById('stats-config-list');
            list.innerHTML = '';
            (storyData.config.stats || []).forEach((stat, idx) => {
                const row = document.createElement('div');
                row.className = 'row';
                row.style.marginBottom = '10px';
                row.innerHTML = `
                    <div class="col">
                        <input placeholder="ID (é™è‹±æ–‡)" value="${stat.id}" 
                        oninput="this.value = this.value.replace(/[^a-zA-Z0-9_]/g, ''); updateStatConfig(${idx}, 'id', this.value)">
                    </div>
                    <div class="col"><input placeholder="é¡¯ç¤ºåç¨±" value="${stat.name}" oninput="updateStatConfig(${idx}, 'name', this.value)"></div>
                    <div class="col" style="flex:0.5"><input type="number" placeholder="åˆå§‹å€¼" value="${stat.init}" oninput="updateStatConfig(${idx}, 'init', parseInt(this.value))"></div>
                    <div class="col" style="flex:0.5"><input type="color" value="${stat.color}" oninput="updateStatConfig(${idx}, 'color', this.value)" style="height:35px; padding:0;"></div>
                    <button class="danger sm" onclick="removeStatConfig(${idx})">Ã—</button>
                `;
                list.appendChild(row);
            });
        }

        function renderItemConfigList() {
            const list = document.getElementById('items-config-list');
            list.innerHTML = '';
            (storyData.config.items || []).forEach((item, idx) => {
                const row = document.createElement('div');
                row.className = 'row';
                row.style.marginBottom = '10px';
                row.innerHTML = `
                    <div class="col" style="flex:0.5"><input placeholder="ID (å¦‚ key)" value="${item.id}" oninput="updateItemConfig(${idx}, 'id', this.value)"></div>
                    <div class="col"><input placeholder="é“å…·åç¨±" value="${item.name}" oninput="updateItemConfig(${idx}, 'name', this.value)"></div>
                    <div class="col" style="flex:1.5"><input placeholder="æè¿°" value="${item.desc||''}" oninput="updateItemConfig(${idx}, 'desc', this.value)"></div>
                    <button class="danger sm" onclick="removeItemConfig(${idx})">Ã—</button>
                `;
                list.appendChild(row);
            });
        }

        // 2. å ´æ™¯ (Scene)
        function renderSceneEditor(sceneId) {
            const scene = storyData.scenes[sceneId];
            const container = document.getElementById('editor-content-area');
            document.getElementById('editor-title').innerText = `ç·¨è¼¯å ´æ™¯: ${sceneId}`;
            
            if (sceneId === 'intro') {
                document.getElementById('btn-delete').classList.add('hidden');
            } else {
                document.getElementById('btn-delete').classList.remove('hidden');
            }

            const disabledAttr = (sceneId === 'intro') ? 'disabled title="èµ·å§‹å ´æ™¯ ID ä¸å¯è®Šæ›´"' : '';
            const idInputStyle = (sceneId === 'intro') ? 'border-color: #d4af37;' : '';

            container.innerHTML = `
                <div class="form-group">
                    <label>å ´æ™¯ ID ${sceneId === 'intro' ? '(èµ·å§‹å ´æ™¯ä¸å¯æ›´å)' : '(æ›´æ”¹å¾Œæœƒè‡ªå‹•æ›´æ–°åƒç…§)'}</label>
                    <input type="text" value="${sceneId}" style="${idInputStyle}" ${disabledAttr} onchange="renameScene('${sceneId}', this.value)">
                </div>

                <div class="row">
                    <div class="col form-group">
                        <label>èƒŒæ™¯åœ– (images/...)</label>
                        <input type="text" value="${scene.bg || ''}" oninput="updateSceneData('${sceneId}', 'bg', this.value)">
                    </div>
                    <div class="col form-group">
                        <label>èƒŒæ™¯éŸ³æ¨‚ (audio/...)</label>
                        <input type="text" value="${scene.bgm || ''}" oninput="updateSceneData('${sceneId}', 'bgm', this.value)">
                    </div>
                    <div class="col form-group">
                        <label>è¦–è¦ºç‰¹æ•ˆ (fx)</label>
                        <select onchange="updateSceneData('${sceneId}', 'fx', this.value)">
                            <option value="" ${!scene.fx ? 'selected':''}>ç„¡</option>
                            <option value="shake" ${scene.fx==='shake'?'selected':''}>éœ‡å‹• (shake)</option>
                            <option value="flash-red" ${scene.fx==='flash-red'?'selected':''}>ç´…é–ƒ (å—å‚·)</option>
                            <option value="flash-white" ${scene.fx==='flash-white'?'selected':''}>ç™½é–ƒ (å›æ†¶)</option>
                            <option value="blur" ${scene.fx==='blur'?'selected':''}>æ¨¡ç³Š</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>å°è©±å…§å®¹ (ä¸€è¡Œä¸€å¥ï¼Œæ”¯æ´ &lt;b&gt;HTML&lt;/b&gt;)</label>
                    <textarea style="height: 150px;" oninput="updateDialogues('${sceneId}', this.value)">${(scene.dialogues || []).join('\n')}</textarea>
                </div>

                <h3>æŠ‰æ“‡é¸é … (Choices)</h3>
                <div id="choices-list"></div>
                <button class="primary" style="width:100%" onclick="addChoice('${sceneId}')">+ æ–°å¢é¸é …</button>
            `;
            
            renderChoices(sceneId);
        }

        function renderChoices(sceneId) {
            const container = document.getElementById('choices-list');
            container.innerHTML = '';
            const scene = storyData.scenes[sceneId];
            const allScenes = Object.keys(storyData.scenes);

            (scene.choices || []).forEach((choice, idx) => {
                const box = document.createElement('div');
                box.className = 'card-box';
                
                const reqStat = choice.req ? choice.req.stat : '';
                const reqOp = choice.req ? choice.req.op : '>';
                const reqVal = choice.req ? choice.req.val : 0;
                
                const isReset = choice.isReset === true;

                // è§£æ effects UI
                let effectsHTML = `<div class="stats-grid">`;
                storyData.config.stats.forEach(stat => {
                    const val = (choice.effects && choice.effects[stat.id] !== undefined) ? choice.effects[stat.id] : 0;
                    const placeholder = isReset ? 'è¨­å®šç‚º (ç›´æ¥è¦†è“‹)' : 'ç´¯åŠ  (è¼¸å…¥æ­£è² æ•¸)';
                    const labelSign = isReset ? '(=)' : '(+)';
                    
                    effectsHTML += `
                        <div class="stat-input-group">
                            <label>${stat.name} <span style="color:${isReset?'#e74c3c':'#aaa'}">${labelSign}</span></label>
                            <input type="number" placeholder="${placeholder}" value="${val}" onchange="updateChoiceEffect('${sceneId}', ${idx}, '${stat.id}', this.value)">
                        </div>`;
                });
                effectsHTML += `</div>`;

                // æ™ºæ…§ä¸‹æ‹‰é¸å–®
                let sceneOptionsHTML = `<option value="end_calc" style="color:#d4af37; font-weight:bold;">ğŸ è§¸ç™¼çµå±€è¨ˆç®— (end_calc)</option>`;
                let foundCurrent = (choice.nextScene === 'end_calc');
                allScenes.forEach(sKey => {
                    const selected = (sKey === choice.nextScene) ? 'selected' : '';
                    if (selected) foundCurrent = true;
                    sceneOptionsHTML += `<option value="${sKey}" ${selected}>${sKey}</option>`;
                });
                if (!foundCurrent && choice.nextScene) {
                        sceneOptionsHTML += `<option value="${choice.nextScene}" selected style="color:#e74c3c;">âš ï¸ æœªçŸ¥/å·²åˆªé™¤: ${choice.nextScene}</option>`;
                }

                box.innerHTML = `
                    <div class="card-header-actions">
                        <button class="danger sm" onclick="removeChoice('${sceneId}', ${idx})">åˆªé™¤</button>
                    </div>
                    
                    <div class="form-group">
                        <label>æŒ‰éˆ•æ–‡å­—</label>
                        <input type="text" value="${choice.text}" oninput="updateChoiceProp('${sceneId}', ${idx}, 'text', this.value)">
                    </div>

                    <div class="form-group">
                        <label>è·³è½‰ç›®æ¨™</label>
                        <select style="font-family: monospace;" onchange="updateChoiceProp('${sceneId}', ${idx}, 'nextScene', this.value);">
                            ${sceneOptionsHTML}
                        </select>
                    </div>

                    <details id="details-${sceneId}-${idx}">
                        <summary style="cursor:pointer; color:var(--accent); margin:10px 0;">æ•¸å€¼è®Šå‹• (Effects)</summary>
                        
                        <div style="margin-bottom: 10px; background: ${isReset ? 'rgba(231, 76, 60, 0.1)' : '#252526'}; padding: 12px; border-radius: 6px; border: 1px solid ${isReset ? '#e74c3c' : '#444'}; display:flex; align-items:center; transition: all 0.3s;">
                            <label class="t-switch">
                                <input type="checkbox" ${isReset ? 'checked' : ''} 
                                    onchange="updateChoiceProp('${sceneId}', ${idx}, 'isReset', this.checked); renderChoices('${sceneId}'); document.getElementById('details-${sceneId}-${idx}').open = true;">
                                <span class="t-slider"></span>
                            </label>

                            <div style="flex-grow:1;">
                                <label style="margin:0; cursor:pointer; font-weight:bold; display:block; color:${isReset ? '#e74c3c' : '#aaa'}; font-size: 0.95rem;">
                                    ${isReset ? 'âš ï¸ å¼·åˆ¶é‡ç½® (Reset)' : 'â• æ•¸å€¼ç´¯åŠ  (Accumulate)'}
                                </label>
                                <div style="font-size: 0.8rem; color: #777; margin-top: 4px;">
                                    ${isReset ? 'è­¦å‘Šï¼šæ­¤é¸é …å°‡ç›´æ¥ã€Œè¦†è“‹ã€ä¸¦å–ä»£ç©å®¶åŸæœ¬çš„æ•¸å€¼ã€‚' : 'æ¨™æº–æ¨¡å¼ï¼šåœ¨ç¾æœ‰æ•¸å€¼ä¸Šé€²è¡ŒåŠ æ¸›é‹ç®—ã€‚'}
                                </div>
                            </div>
                        </div>
                        ${effectsHTML}
                    </details>

                    <details>
                        <summary style="cursor:pointer; color:var(--accent); margin:10px 0;">é“å…·é‚è¼¯ (Items)</summary>
                        <div style="background:#222; padding:10px;">
                            <div class="form-group">
                                <label>ç²å¾—é“å…· (Gain Items) - è¼¸å…¥ IDï¼Œå¤šå€‹ç”¨é€—è™Ÿåˆ†éš”</label>
                                <input type="text" placeholder="ä¾‹å¦‚: key, map" value="${(choice.gainItems||[]).join(',')}" 
                                onchange="updateChoiceItems('${sceneId}', ${idx}, 'gainItems', this.value)">
                            </div>
                            <div class="form-group">
                                <label>æ¶ˆè€—/ç§»é™¤é“å…· (Lose Items)</label>
                                <input type="text" placeholder="ä¾‹å¦‚: potion" value="${(choice.loseItems||[]).join(',')}" 
                                onchange="updateChoiceItems('${sceneId}', ${idx}, 'loseItems', this.value)">
                            </div>
                            <div class="form-group">
                                <label>å‡ºç¾æ¢ä»¶ï¼šéœ€æŒæœ‰é“å…· (Require Item)</label>
                                <select onchange="updateChoiceProp('${sceneId}', ${idx}, 'reqItem', this.value)">
                                    <option value="">ç„¡</option>
                                    ${(storyData.config.items||[]).map(i => `<option value="${i.id}" ${choice.reqItem===i.id?'selected':''}>${i.name} (${i.id})</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </details>

                    <details>
                        <summary style="cursor:pointer; color:var(--accent); margin:10px 0;">å‡ºç¾æ¢ä»¶ (Stats Req)</summary>
                        <div class="row" style="align-items:center; background:#222; padding:10px;">
                            <select style="flex:1" onchange="updateChoiceReq('${sceneId}', ${idx}, 'stat', this.value)">
                                <option value="">ç„¡æ¢ä»¶</option>
                                ${storyData.config.stats.map(s => `<option value="${s.id}" ${reqStat===s.id?'selected':''}>${s.name}</option>`).join('')}
                            </select>
                            <select style="flex:0.5" onchange="updateChoiceReq('${sceneId}', ${idx}, 'op', this.value)">
                                <option value=">" ${reqOp==='>'?'selected':''}> &gt; </option>
                                <option value=">=" ${reqOp==='>='?'selected':''}> &ge; </option>
                                <option value="<" ${reqOp==='<'?'selected':''}> &lt; </option>
                                <option value="<=" ${reqOp==='<='?'selected':''}> &le; </option>
                                <option value="==" ${reqOp==='=='?'selected':''}> = </option>
                            </select>
                            <input type="number" style="flex:0.5" value="${reqVal}" onchange="updateChoiceReq('${sceneId}', ${idx}, 'val', this.value)">
                        </div>
                    </details>
                    
                    <details>
                        <summary style="cursor:pointer; color:var(--accent); margin:10px 0;">è§£æå›é¡§ (Analysis)</summary>
                        <div style="background:#222; padding:10px;">
                            <div class="row form-group">
                                <div class="col"><label>æ¨™é¡Œ</label><input value="${choice.analysis?.title||''}" oninput="updateChoiceAnalysis('${sceneId}', ${idx}, 'title', this.value)"></div>
                                <div class="col" style="flex:0.5">
                                    <label>ç‹€æ…‹</label>
                                    <select onchange="updateChoiceAnalysis('${sceneId}', ${idx}, 'status', this.value)">
                                        <option value="info" ${choice.analysis?.status==='info'?'selected':''}>ä¸€èˆ¬</option>
                                        <option value="success" ${choice.analysis?.status==='success'?'selected':''}>ç¬¦åˆ</option>
                                        <option value="warning" ${choice.analysis?.status==='warning'?'selected':''}>èƒŒé›¢</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group"><label>è§£æå…§å®¹</label><textarea style="min-height:50px" oninput="updateChoiceAnalysis('${sceneId}', ${idx}, 'content', this.value)">${choice.analysis?.content||''}</textarea></div>
                        </div>
                    </details>
                `;
                container.appendChild(box);
            });
        }

        // 3. çµå±€ (Ending)
        function renderEndingEditor(index) {
            const ending = storyData.endings[index];
            const container = document.getElementById('editor-content-area');
            document.getElementById('editor-title').innerText = `ç·¨è¼¯çµå±€: ${ending.title || 'Untitled'}`;
            document.getElementById('btn-delete').classList.remove('hidden');

            let conditionsHTML = `<div id="cond-list">`;
            (ending.conditions || []).forEach((cond, cIdx) => {
                conditionsHTML += `
                    <div class="row" style="margin-bottom:5px;">
                        <select onchange="updateEndingCond(${index}, ${cIdx}, 'stat', this.value)">
                            ${storyData.config.stats.map(s => `<option value="${s.id}" ${cond.stat===s.id?'selected':''}>${s.name}</option>`).join('')}
                        </select>
                        <select style="width:60px" onchange="updateEndingCond(${index}, ${cIdx}, 'op', this.value)">
                            <option value=">=" ${cond.op==='>='?'selected':''}>&ge;</option>
                            <option value="<=" ${cond.op==='<='?'selected':''}>&le;</option>
                            <option value="==" ${cond.op==='=='?'selected':''}>=</option>
                            <option value=">" ${cond.op==='>'?'selected':''}>&gt;</option>
                            <option value="<" ${cond.op==='<'?'selected':''}>&lt;</option>
                        </select>
                        <input type="number" value="${cond.val}" onchange="updateEndingCond(${index}, ${cIdx}, 'val', this.value)">
                        <button class="danger sm" onclick="removeEndingCond(${index}, ${cIdx})">Ã—</button>
                    </div>`;
            });
            conditionsHTML += `</div><button class="outline sm" onclick="addEndingCond(${index})">+ å¢åŠ æ¢ä»¶</button>`;

            container.innerHTML = `
                <div class="row">
                    <div class="col form-group">
                        <label>çµå±€ ID (Unique)</label>
                        <input type="text" value="${ending.id}" oninput="updateEndingProp(${index}, 'id', this.value)">
                    </div>
                    <div class="col form-group">
                        <label>å„ªå…ˆæ¬Š (Priority) - æ•¸å­—è¶Šå¤§è¶Šå…ˆåˆ¤æ–·</label>
                        <input type="number" value="${ending.priority}" oninput="updateEndingProp(${index}, 'priority', parseInt(this.value))">
                    </div>
                </div>
                <div class="form-group">
                    <label>çµå±€æ¨™é¡Œ</label>
                    <input type="text" value="${ending.title}" oninput="updateEndingProp(${index}, 'title', this.value)">
                </div>
                <div class="form-group">
                    <label>çµå±€åœ–ç‰‡</label>
                    <input type="text" value="${ending.image}" oninput="updateEndingProp(${index}, 'image', this.value)">
                </div>
                <div class="form-group">
                    <label>æè¿°æ–‡å­—</label>
                    <textarea oninput="updateEndingProp(${index}, 'desc', this.value)">${ending.desc}</textarea>
                </div>
                <div class="form-group">
                    <label>åè¨€å¼•ç”¨</label>
                    <input type="text" value="${ending.quote||''}" oninput="updateEndingProp(${index}, 'quote', this.value)">
                </div>
                <div class="card-box">
                    <label>è§¸ç™¼æ¢ä»¶ (æ‰€æœ‰æ¢ä»¶çš†ç¬¦åˆæ‰è§¸ç™¼)</label>
                    ${conditionsHTML}
                </div>
            `;
        }

        // ==========================================================
        //  è³‡æ–™æ›´æ–°æ“ä½œ
        // ==========================================================
        
        function updateStatConfig(idx, field, val) { storyData.config.stats[idx][field] = val; }
        function addStatConfig() { storyData.config.stats.push({id:'new', name:'æ–°æ•¸å€¼', init:0, color:'#ffffff'}); renderStatConfigList(); }
        function removeStatConfig(idx) { storyData.config.stats.splice(idx, 1); renderStatConfigList(); }

        // --- Items CRUD ---
        function updateItemConfig(idx, field, val) { storyData.config.items[idx][field] = val; }
        function addItemConfig() { 
            if(!storyData.config.items) storyData.config.items = [];
            storyData.config.items.push({id:'new_item', name:'æ–°é“å…·', desc:''}); 
            renderItemConfigList(); 
        }
        function removeItemConfig(idx) { storyData.config.items.splice(idx, 1); renderItemConfigList(); }
        // ------------------

        function updateSceneData(id, field, val) { storyData.scenes[id][field] = val; }
        function updateDialogues(id, val) { storyData.scenes[id].dialogues = val.split('\n').filter(l=>l); }
        function renameScene(oldId, newId) {
            if(!newId || storyData.scenes[newId]) return;
            storyData.scenes[newId] = storyData.scenes[oldId];
            delete storyData.scenes[oldId];
            
            Object.values(storyData.scenes).forEach(s => {
                (s.choices||[]).forEach(c => { if(c.nextScene === oldId) c.nextScene = newId; });
            });

            currentId = newId;
            renderList();
            renderSceneEditor(newId);
        }
        function addNewScene() {
            const id = 'scene_' + Math.floor(Math.random()*1000);
            storyData.scenes[id] = { dialogues:["..."], choices:[] };
            currentId = id;
            renderList();
            renderSceneEditor(id);
        }
        
        function deleteCurrentItem() {
            if(currentTab === 'scenes' && currentId === 'intro') {
                alert("âŒ ç„¡æ³•åˆªé™¤ 'intro' å ´æ™¯ï¼\né€™æ˜¯æ•…äº‹çš„èµ·å§‹é»ï¼Œå¿…é ˆä¿ç•™ã€‚");
                return;
            }

            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
            if(currentTab==='scenes') {
                delete storyData.scenes[currentId];
                currentId = Object.keys(storyData.scenes)[0] || '';
            } else {
                storyData.endings.splice(currentId, 1);
                currentId = 0;
            }
            renderList();
            document.getElementById('editor-content-area').innerHTML = '';
        }

        function addChoice(sceneId) {
            if(!storyData.scenes[sceneId].choices) storyData.scenes[sceneId].choices = [];
            storyData.scenes[sceneId].choices.push({ text:"æ–°é¸é …", nextScene:sceneId, effects:{} });
            renderChoices(sceneId);
        }
        function removeChoice(sceneId, idx) {
            storyData.scenes[sceneId].choices.splice(idx, 1);
            renderChoices(sceneId);
        }
        function updateChoiceProp(sId, cIdx, field, val) { storyData.scenes[sId].choices[cIdx][field] = val; }
        
        // --- Choice Items Update Helper ---
        function updateChoiceItems(sId, cIdx, field, valStr) {
            const arr = valStr.split(',').map(s => s.trim()).filter(s => s);
            if(arr.length === 0) delete storyData.scenes[sId].choices[cIdx][field];
            else storyData.scenes[sId].choices[cIdx][field] = arr;
        }
        // ----------------------------------

        function updateChoiceEffect(sId, cIdx, statId, val) {
            val = parseInt(val);
            if(val === 0) delete storyData.scenes[sId].choices[cIdx].effects[statId];
            else storyData.scenes[sId].choices[cIdx].effects[statId] = val;
        }
        function updateChoiceReq(sId, cIdx, field, val) {
            if(!storyData.scenes[sId].choices[cIdx].req) storyData.scenes[sId].choices[cIdx].req = { stat:storyData.config.stats[0]?.id, op:'>', val:0 };
            
            if (field === 'stat' && val === "") {
                delete storyData.scenes[sId].choices[cIdx].req; 
            } else {
                storyData.scenes[sId].choices[cIdx].req[field] = (field==='val') ? parseInt(val) : val;
            }
            if(field === 'stat') renderChoices(sId); 
        }
        function updateChoiceAnalysis(sId, cIdx, field, val) {
            if(!storyData.scenes[sId].choices[cIdx].analysis) storyData.scenes[sId].choices[cIdx].analysis = { status:'info', title:'', content:'' };
            storyData.scenes[sId].choices[cIdx].analysis[field] = val;
        }

        function addNewEnding() {
            storyData.endings.push({ id:'end_'+Date.now(), title:'æ–°çµå±€', priority:10, conditions:[] });
            currentId = storyData.endings.length-1;
            renderList();
            renderEndingEditor(currentId);
        }
        function updateEndingProp(idx, field, val) { storyData.endings[idx][field] = val; if(field==='title') renderList(); }
        function addEndingCond(idx) { 
            storyData.endings[idx].conditions.push({ stat:storyData.config.stats[0]?.id, op:'>=', val:0 });
            renderEndingEditor(idx);
        }
        function removeEndingCond(idx, cIdx) {
            storyData.endings[idx].conditions.splice(cIdx, 1);
            renderEndingEditor(idx);
        }
        function updateEndingCond(idx, cIdx, field, val) {
            storyData.endings[idx].conditions[cIdx][field] = (field==='val')?parseInt(val):val;
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify(storyData, null, 4)], {type:"application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'story.json';
            a.click();
        }
        function importJSON(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    storyData = JSON.parse(e.target.result);
                    if(!storyData.scenes) storyData.scenes = {};
                    if(!storyData.endings) storyData.endings = [];
                    if(!storyData.config) storyData.config = { stats: [] };
                    if(!storyData.config.items) storyData.config.items = []; // è‡ªå‹•è£œä¸Š items é™£åˆ—
                    alert("åŒ¯å…¥æˆåŠŸï¼");
                    currentTab = 'scenes';
                    renderList();
                    document.getElementById('editor-content-area').innerHTML = '';
                } catch(err) { alert("æ ¼å¼éŒ¯èª¤"); }
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>